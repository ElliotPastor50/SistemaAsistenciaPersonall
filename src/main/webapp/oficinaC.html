<!DOCTYPE html>
<html lang="es">
    <head>
        <meta charset="UTF-8" />
        <title>Asistencia Oficina C</title>

        <!-- Bootstrap + íconos -->
        <link href="https://cdn.jsdelivr.net/npm/startbootstrap-sb-admin-2@4.0.7/css/sb-admin-2.min.css" rel="stylesheet" />
        <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
        <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"> 
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
        <link href="style.css" rel="stylesheet" />

        <style>
            body {
                padding-top: 70px;
            }
        </style>
    </head>

    <body class="bg-gradient-primary">

        <div class="container mt-5">

            <!-- Barra superior fija -->
            <nav class="navbar navbar-expand navbar-dark bg-dark shadow fixed-top">
                <div class="container-fluid">
                    <span class="navbar-brand mb-0 h1">
                        <i class="fas fa-clock me-2"></i> Sistema de Asistencia
                    </span>
                    <ul class="navbar-nav ms-auto">
                        <li class="nav-item me-2">
                            <a href="menu.html" class="btn btn-outline-light btn-sm">
                                <i class="fas fa-arrow-circle-left"></i> Volver al menú
                            </a>
                        </li>
                        <li class="nav-item">
                            <button class="btn btn-danger btn-sm" onclick="cerrarSesion()">
                                <i class="fas fa-right-from-bracket me-1"></i> Cerrar sesión
                            </button>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- Contenedor Principal -->
            <div class="container mt-4">
                <!-- CARD REGISTRO -->
                <div class="card shadow-lg mb-4 uwu-shadow">
                    <div class="card-header bg-primary text-white text-center">
                        <h3 class="font-weight-bold">Registro de Asistencia - Oficina C</h3>
                    </div>
                    <div class="card-body">
                        <!-- Bloques de Información Agrupada -->
                        <div class="info-wrapper d-flex justify-content-around">
                            <div class="info-block text-center">
                                <i class="bi bi-person-circle fs-1"></i>
                                <p id="nombreEmpleado" class="fw-bold mb-0 text-dark">Cargando...</p> 
                                <p class="text-muted" id="correoEmpleado">Cargando...</p> 
                            </div>
                            <div class="info-block text-center">
                                <i class="bi bi-signpost fs-1"></i>
                                <p id="tipoEvento" class="fw-bold mb-0 text-dark">---</p> 
                                <p class="text-muted" id="horaActual">--:--</p>
                            </div>
                        </div>

                        <!-- Botones -->
                        <form id="formEvento" class="btn-group-custom d-flex gap-3 mt-4">
                            <input type="hidden" id="idOficina" value="3" />
                            <input type="hidden" id="idEmpleado" />
                            <input type="hidden" id="tipo" />

                            <button id="btnRegistrar" type="submit" class="btn btn-success btn-lg btn-icon flex-fill">
                                <i class="bi bi-check-circle-fill"></i> Registrar Evento
                            </button>

                            <a href="visualizar.html" class="btn btn-info btn-lg btn-icon flex-fill">
                                <i class="bi bi-eye-fill"></i> Visualizar General
                            </a>
                        </form>

                        <div id="respuesta" class="text-success text-center mt-3"></div>
                    </div>
                </div>

                <!-- CARD TABLA -->
                <div class="card shadow-lg uwu-shadow">
                    <div class="card-header bg-info text-white text-center">
                        <h4><i class="bi bi-clock-history me-2"></i> Eventos Registrados</h4>
                    </div>
                    <div class="card-body table-responsive">
                        <table class="table table-bordered table-hover table-striped align-middle">
                            <thead class="table-dark text-center">
                                <tr>
                                    <th>Empleado</th>
                                    <th>Tipo</th>
                                    <th>Fecha</th>
                                    <th>Hora</th>
                                    <th>Reloj Lógico</th>
                                </tr>
                            </thead>
                            <tbody id="tablaEventos" class="text-center">
                                <!-- Se llena dinámicamente -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- SCRIPT -->
            <script>
                function obtenerHoraActual() {
                    const ahora = new Date();
                    const hora = ahora.getHours().toString().padStart(2, '0');
                    const minutos = ahora.getMinutes().toString().padStart(2, '0');
                    return `${hora}:${minutos}`;
                }

                function obtenerFechaActual() {
                    return new Date().toISOString().split("T")[0];
                }

                function actualizarHora() {
                    document.getElementById("horaActual").innerText = obtenerHoraActual();
                }

                document.getElementById("formEvento").addEventListener("submit", function (e) {
                    e.preventDefault();

                    const btn = document.getElementById("btnRegistrar");
                    btn.disabled = true;

                    const datos = {
                        idOficina: document.getElementById("idOficina").value,
                        idEmpleado: document.getElementById("idEmpleado").value,
                        fecha: obtenerFechaActual(),
                        hora: obtenerHoraActual()
                    };

                    fetch("registrarEvento", {
                        method: "POST",
                        headers: {"Content-Type": "application/json"},
                        body: JSON.stringify(datos)
                    })
                            .then(res => res.json())
                            .then(json => {
                                document.getElementById("respuesta").innerText = json.mensaje;
                                document.getElementById("tipoEvento").innerText = json.tipo;
                                document.getElementById("tipo").value = json.tipo;
                                cargarEventos();
                                actualizarEstadoEvento();
                                btn.disabled = false;
                            })
                            .catch(error => {
                                document.getElementById("respuesta").innerText = "Error al registrar: " + error.toString();
                                btn.disabled = false;
                            });
                });

                function cargarEventos() {
                    const idOficinaActual = document.getElementById("idOficina").value;

                    fetch(`eventos?oficina=${idOficinaActual}`)
                            .then(res => res.json())
                            .then(data => {
                                const tbody = document.getElementById("tablaEventos");
                                tbody.innerHTML = "";

                                if (data.length === 0) {
                                    tbody.innerHTML = `<tr><td colspan="5" class="text-muted">No hay eventos registrados.</td></tr>`;
                                    return;
                                }

                                data.forEach(evento => {
                                    const fila = document.createElement("tr");
                                    fila.innerHTML = `
                                <td>${evento.nombreEmpleado}</td>
                                <td>${evento.tipo}</td>
                                <td>${evento.fecha}</td>
                                <td>${evento.hora}</td>
                                <td>${evento.relojLamport}</td>
                            `;
                                    tbody.appendChild(fila);
                                });
                            })
                            .catch(error => {
                                console.error("Error al cargar eventos:", error);
                                document.getElementById("tablaEventos").innerHTML =
                                        `<tr><td colspan="5" class="text-danger">Error al cargar los eventos</td></tr>`;
                            });
                }

                function actualizarEstadoEvento() {
                    const idEmpleado = document.getElementById("idEmpleado").value;
                    const idOficina = document.getElementById("idOficina").value;

                    if (!idEmpleado || !idOficina)
                        return;

                    console.log("Actualizando estado evento para empleado:", idEmpleado);

                    fetch(`eventos?accion=ultimo&idEmpleado=${idEmpleado}&idOficina=${idOficina}`)
                            .then(res => res.json())
                            .then(data => {
                                let siguiente = "ENTRADA";
                                if (data && data.tipo === "ENTRADA") {
                                    siguiente = "SALIDA";
                                } else if (data && data.tipo === "SALIDA") {
                                    siguiente = "ENTRADA";
                                }
                                console.log("Último evento:", data.tipo, "| Siguiente será:", siguiente);

                                document.getElementById("tipoEvento").innerText = siguiente;
                                document.getElementById("tipo").value = siguiente;
                            })
                            .catch(() => {
                                document.getElementById("tipoEvento").innerText = "ENTRADA";
                                document.getElementById("tipo").value = "ENTRADA";
                            });
                }


                window.addEventListener("DOMContentLoaded", function () {
                    fetch("datosUsuario")
                            .then(res => res.json())
                            .then(data => {
                                document.getElementById("idEmpleado").value = data.idEmpleado;
                                document.getElementById("nombreEmpleado").innerText = data.nombre;
                                document.getElementById("correoEmpleado").innerText = data.correo;

                                actualizarEstadoEvento();
                            })
                            .catch(() => {
                                document.getElementById("nombreEmpleado").innerText = "Desconocido";
                                document.getElementById("correoEmpleado").innerText = "Desconocido";
                            });

                    actualizarHora();
                    setInterval(actualizarHora, 1000);

                    cargarEventos();
                    setInterval(cargarEventos, 3000);
                });

                function cerrarSesion() {
                    if (confirm("Desea cerrar sesión?")) {
                        fetch("logout", {method: "POST"})
                                .then(() => {
                                    window.location.href = "index.html";
                                })
                                .catch(error => {
                                    console.error("Error cerrando sesión:", error);
                                    alert("No se pudo cerrar sesión.");
                                });
                    }
                }

            </script>
    </body>
</html>
