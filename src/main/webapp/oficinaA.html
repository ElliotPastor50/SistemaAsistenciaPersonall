<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <title>Oficina A - Asistencia</title>
    <link href="https://cdn.jsdelivr.net/npm/startbootstrap-sb-admin-2@4.0.7/css/sb-admin-2.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body class="bg-gradient-primary">

<div class="container mt-5">
    <div class="card shadow mb-4">
        <div class="card-header bg-primary text-white">
            <h3 class="m-0 font-weight-bold">Registro de Asistencia - Oficina A</h3>
        </div>
        <div class="card-body">

            <div class="mb-4">
                <h5>Empleado:</h5>
                <p><strong id="nombreEmpleado">Cargando...</strong></p>
                <p><strong id="correoEmpleado">Cargando...</strong></p>
            </div>

            <form id="formEvento">
                <input type="hidden" id="idOficina" value="1">
                <input type="hidden" id="idEmpleado" />
                <button type="submit" class="btn btn-success">Marcar Asistencia</button>
                <a href="visualizar.html" class="btn btn-info">Visualizar General</a>
            </form>

            <div id="respuesta" class="mt-3 text-success"></div>
        </div>
    </div>

    <div class="card shadow">
        <div class="card-header bg-info text-white">
            <h4 class="m-0">Eventos Registrados</h4>
        </div>
        <div class="card-body">
            <table class="table table-bordered table-hover">
                <thead class="thead-dark">
                    <tr>
                        <th>Empleado</th>
                        <th>Tipo</th>
                        <th>Fecha</th>
                        <th>Hora</th>
                        <th>Reloj Lógico</th>
                    </tr>
                </thead>
                <tbody id="tablaEventos">
                    <!-- Se llena dinámicamente -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    document.getElementById("formEvento").addEventListener("submit", function (e) {
        e.preventDefault();

        const datos = {
            idOficina: document.getElementById("idOficina").value,
            idEmpleado: document.getElementById("idEmpleado").value
        };

        fetch("registrarEvento", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(datos)
        })
        .then(res => res.json())
        .then(json => {
            document.getElementById("respuesta").innerText = json.mensaje;
            cargarEventos();
        })
        .catch(error => {
            document.getElementById("respuesta").innerText = "Error al registrar: " + error.toString();
        });
    });

    function cargarEventos() {
        const idOficinaActual = document.getElementById("idOficina").value;

        fetch(`eventos?oficina=${idOficinaActual}`)
        .then(res => res.json())
        .then(data => {
            const tbody = document.getElementById("tablaEventos");
            tbody.innerHTML = "";

            if (data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" class="text-muted">No hay eventos registrados.</td></tr>`;
                return;
            }

            data.forEach(evento => {
                const fila = document.createElement("tr");
                fila.innerHTML = `
                    <td>${evento.nombreEmpleado}</td>
                    <td>${evento.tipo}</td>
                    <td>${evento.fecha}</td>
                    <td>${evento.hora}</td>
                    <td>${evento.relojLamport}</td>
                `;
                tbody.appendChild(fila);
            });
        })
        .catch(error => {
            console.error("Error al cargar eventos:", error);
            document.getElementById("tablaEventos").innerHTML =
                `<tr><td colspan="5" class="text-danger">Error al cargar los eventos</td></tr>`;
        });
    }

    window.onload = function () {
        cargarEventos();
    };

    window.addEventListener("DOMContentLoaded", function () {
        fetch("datosUsuario")
        .then(res => res.json())
        .then(data => {
            document.getElementById("idEmpleado").value = data.idEmpleado;
            document.getElementById("nombreEmpleado").innerText = data.nombre + " " + data.apellido;
            document.getElementById("correoEmpleado").innerText = data.correo;
        })
        .catch(err => {
            console.error("Error al cargar datos de sesión:", err);
            document.getElementById("nombreEmpleado").innerText = "Desconocido";
            document.getElementById("correoEmpleado").innerText = "Desconocido";
        });
    });
</script>

</body>
</html>
