<!DOCTYPE html>
<html lang="es">
    <head>
        <meta charset="UTF-8" />
        <title>Visualización de Asistencia y Eventos</title>

        <!-- Bootstrap y estilo base -->
        <link href="https://cdn.jsdelivr.net/npm/startbootstrap-sb-admin-2@4.0.7/css/sb-admin-2.min.css" rel="stylesheet" />
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

        <!-- Vis.js -->
        <script src="https://unpkg.com/vis-network@9.1.2/dist/vis-network.min.js"></script>
        <link href="https://unpkg.com/vis-network@9.1.2/dist/vis-network.min.css" rel="stylesheet" />

        <!-- Tu archivo de estilos -->
        <link href="style.css" rel="stylesheet" />
    </head>
    <body class="bg-gradient-info">

        <div class="container mt-5">

            <!-- CARD TABLA ASISTENCIA -->
            <div class="card shadow-lg mb-5 uwu-shadow">
                <div class="card-header bg-primary text-white text-center">
                    <h3 class="font-weight-bold" id="titulo">Tabla de Asistencia</h3>
                </div>
                <div class="card-body table-responsive">
                    <table id="tabla-empleados" class="table table-bordered table-hover table-striped align-middle text-center">
                        <thead class="table-dark">
                            <tr>
                                <th>Empleado</th>
                                <th>Oficina</th>
                                <th>Tipo</th>
                                <th>Hora</th>
                                <th>Lamport</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Datos insertados dinámicamente -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- CARD GRAFO -->
            <div class="card shadow-lg uwu-shadow">
                <div class="card-header bg-success text-white text-center">
                    <h3 class="font-weight-bold">Visualización de Eventos con Relojes de Lamport</h3>
                </div>
                <div class="card-body">
                    <div id="graph" style="height: 600px;"></div>
                </div>
            </div>
        </div>



        <!-- Script para la tabla -->
        <script>
            document.addEventListener("DOMContentLoaded", () => {
                const params = new URLSearchParams(window.location.search);
                const oficina = params.get("oficina");
                const titulo = document.getElementById("titulo");
                const tablaBody = document.querySelector("#tabla-empleados tbody");

                const endpoint = oficina ? `/eventos?oficina=${oficina}` : `eventos`;

                if (oficina) {
                    titulo.textContent = `Tabla de Asistencia - Oficina ${oficina}`;
                } else {
                    titulo.textContent = "Tabla General de Asistencia";
                }


                const actualizarTabla = async () => {
                    try {
                        const response = await fetch(endpoint);
                        const datos = await response.json();
                        datos.sort((a, b) => a.relojLamport - b.relojLamport);
                        tablaBody.innerHTML = datos.map(evento => `
                            <tr>
                                <td>${evento.nombreEmpleado}</td>
                                <td>${evento.nombreOficina}</td>
                                <td>${evento.tipo}</td>
                                <td>${evento.hora}</td>
                                <td>${evento.relojLamport}</td>
                            </tr>
                        `).join('');
                    } catch (err) {
                        console.error("Error al obtener datos:", err);
                        tablaBody.innerHTML = "<tr><td colspan='5'>Error cargando datos</td></tr>";
                    }
                };

                actualizarTabla();
                setInterval(actualizarTabla, 3000);
            });
        </script>

        <!-- Script para el grafo -->
        <script>
            fetch("eventos")
                    .then(res => res.json())
                    .then(data => {
                        const nodes = [];
                        const edges = [];

                        data.forEach((evento, index) => {
                            console.log(evento);
                            nodes.push({
                                id: index,
                                label: `${evento.tipo}\n${evento.nombreEmpleado}\n${evento.nombreOficina}\n${evento.fecha} ${evento.hora}`,
                                title: `Reloj lógico: ${evento.relojLamport}`,
                                shape: "box",
                                group: evento.nombreOficina
                            });
                        });

                        for (let i = 1; i < data.length; i++) {
                            edges.push({
                                from: i - 1,
                                to: i,
                                arrows: 'to',
                                label: `→ ${data[i].relojLamport}`,
                                font: {align: "middle"}
                            });
                        }

                        const container = document.getElementById("graph");
                        const networkData = {nodes: new vis.DataSet(nodes), edges: new vis.DataSet(edges)};
                        const options = {
                            layout: {hierarchical: false},
                            nodes: {
                                borderWidth: 1,
                                shape: "box",
                                color: {
                                    border: "#2c3e50",
                                    background: "#3498db",
                                    highlight: {border: "#e74c3c", background: "#f1c40f"}
                                },
                                font: {color: "#ffffff"}
                            },
                            edges: {color: "#7f8c8d"},
                            physics: {
                                enabled: true,
                                solver: "forceAtlas2Based",
                                stabilization: {iterations: 150}
                            }
                        };

                        new vis.Network(container, networkData, options);
                    })
                    .catch(err => {
                        console.error("Error al cargar eventos:", err);
                        document.getElementById("graph").innerHTML = `<p class="text-danger">No se pudieron cargar los eventos</p>`;
                    });
        </script>

    </body>
</html>s